<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.languagetool.server.WikipediaMapper">
    <select id="selectWikipediaArticle" resultType="org.languagetool.server.CorpusArticleEntry">
        SELECT * FROM corpus_article WHERE id=#{id}
    </select>
    <select id="selectNonAppliedWikipediaSuggestions" resultType="org.languagetool.server.CorpusMatchEntry">
        SELECT * FROM corpus_match m WHERE article_id in (select id from corpus_article where language_code IN
        <foreach item="item" index="index" collection="languageCodes"
                 open="(" separator="," close=")">
            #{item}
        </foreach>
        ) AND applied IS NULL ORDER BY RAND() LIMIT 10
    </select>
    <select id="selectWikipediaSuggestion" resultType="org.languagetool.server.CorpusMatchEntry">
        SELECT * FROM corpus_match WHERE id=#{id}
    </select>
    <select id="updateWikipediaSuggestion">
        UPDATE corpus_match SET applied=#{applied}, applied_date=current_timestamp(), applied_reason=#{reason}, applied_username=#{username} WHERE id=#{id}
    </select>
    <select id="selectAccessToken" resultType="org.languagetool.server.AccessToken">
        SELECT * FROM access_token WHERE access_token=#{accessToken} AND language_code=#{languageCode}
    </select>
    <select id="getDecisionStats" resultType="org.languagetool.server.DatabaseAccess$DayStatistics">
        select distinct date_format(applied_date, '%Y-%m-%d'),
                        alias.applied,
                        (select count(*)
                         from corpus_match
                         where applied = alias.applied
                           AND date_format(applied_date, '%Y-%m-%d') =
                               date_format(resolutions.applied_date, '%Y-%m-%d')
                        ) as count
        FROM corpus_match resolutions
                 JOIN (select 0 as applied union select 1 as applied) as alias
        WHERE applied_date is not null
        ORDER BY date_format(applied_date, '%Y-%m-%d'), alias.applied
    </select>
    <select id="getContributionStats" resultType="org.languagetool.server.DatabaseAccess$ContributionStatisticsPerMonth">
        SELECT date_format(applied_date, '%Y-%m') as month, language_code, applied_username, count(*)
        FROM corpus_match
        INNER JOIN corpus_article ca on corpus_match.article_id = ca.id
        WHERE applied_date is not null
        GROUP BY month, language_code, applied_username
        ORDER BY month, count(*) DESC
    </select>
    <select id="insertAccessToken">
        INSERT INTO access_token(language_code, username, access_token, access_token_secret) VALUES(#{languageCode}, #{username}, #{accessToken}, #{accessTokenSecret})
    </select>
</mapper>
